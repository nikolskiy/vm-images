# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Use the latest stable official Debian 64-bit box (currently Debian 12 "Bookworm").
  # Vagrant will automatically check for updates to this box.
  config.vm.box = "debian/bookworm64"

  # Configure the VirtualBox provider.
  config.vm.provider "virtualbox" do |vb|
    # Display the VirtualBox GUI when the machine is booted.
    vb.gui = true

    # Allocate more resources for a better desktop experience.
    # Adjust these values based on your host machine's capabilities.
    vb.memory = "4096"  # 4 GB of RAM
    vb.cpus = 2         # 2 CPU cores
  end

  # Assign a static private IP address to the VM.
  config.vm.network "private_network", ip: "192.168.56.10"

  # Provision the machine with a shell script to install the desktop environment.
  # This script runs the first time you `vagrant up` the machine.
  config.vm.provision "shell", inline: <<-SHELL
    echo "Updating package lists..."
    apt-get update

    echo "Installing XFCE desktop environment, LightDM display manager, and SSH server..."
    # Use DEBIAN_FRONTEND=noninteractive to prevent interactive prompts during installation.
    export DEBIAN_FRONTEND=noninteractive
    
    # Install the full XFCE desktop meta-package and the LightDM login manager.
    # Using task-xfce-desktop ensures all common desktop components are included.
    apt-get install -y task-xfce-desktop lightdm openssh-server

    # Update all the packages
    apt-get upgrade -y

  SHELL

  # Shell provisioner to enable password authentication
  config.vm.provision "shell", inline: <<-SHELL
    echo "Enabling SSH password authentication..."

    # Use sed to change the PasswordAuthentication setting in sshd_config
    # This regex finds '#PasswordAuthentication no' or 'PasswordAuthentication no' 
    # and changes it to 'PasswordAuthentication yes'
    sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

    # 3. Restart the SSH service to apply changes.
    # Using a generic approach that works on most modern Linux systems (Ubuntu/CentOS/etc)
    systemctl restart sshd || sudo service sshd restart

  SHELL

  # Provisioning script to add a user with a specific password.
  config.vm.provision "shell", path: "create_user.sh"

  # Reboot the machine to apply desktop environment changes.
  config.vm.provision "shell", inline: "echo 'Rebooting...' && sudo reboot", run: "once"

end
